<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bicycle Workshop Management</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>BICYCLE WORKSHOP MANAGEMENT</h1>
            <p>Professional bicycle repair and customer management system</p>
        </header>

        <main>
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('register')">Register Bicycle</button>
                <button class="tab-btn" onclick="showTab('jobs')">Job Offers</button>
                <button class="tab-btn" onclick="showTab('history')">History</button>
                <button class="tab-btn" onclick="showTab('database')">Database</button>
            </div>

            <!-- Stage 1: Register Bicycle -->
            <div id="register" class="tab-content active">
                <!-- Customer Selection Screen -->
                <div id="customerSelection" class="customer-selection">
                    <h2>Customer Selection</h2>
                    <div class="selection-options">
                        <div class="option-card" onclick="showNewCustomerForm()">
                            <div class="option-icon">NEW</div>
                            <h3>New Customer</h3>
                            <p>Add a new customer and register their bicycle</p>
                        </div>

                        <div class="option-card" onclick="showExistingCustomerSearch()">
                            <div class="option-icon">SEARCH</div>
                            <h3>Existing Customer</h3>
                            <p>Search for an existing customer to add another bicycle</p>
                        </div>
                    </div>
                </div>

                <!-- New Customer Form -->
                <div id="newCustomerSection" class="customer-form-section" style="display: none;">
                    <h2>New Customer & Bicycle Registration</h2>
                    <button onclick="backToCustomerSelection()" class="back-btn">‚Üê Back to Selection</button>

                    <form id="bicycleForm">
                        <div class="customer-info-section">
                            <h3>Customer Information</h3>
                            <div class="form-group">
                                <label for="customerName">Customer Name:</label>
                                <input type="text" id="customerName" required>
                            </div>

                            <div class="form-group">
                                <label for="phoneNumber">Phone Number:</label>
                                <input type="tel" id="phoneNumber" required>
                            </div>

                            <div class="form-group">
                                <label for="customerEmail">Email (Optional):</label>
                                <input type="email" id="customerEmail">
                            </div>

                            <div class="form-group">
                                <label for="customerAddress">Address (Optional):</label>
                                <textarea id="customerAddress" rows="2" placeholder="Customer address..."></textarea>
                            </div>
                        </div>

                        <div class="bicycle-info-section">
                            <h3>Bicycle Information</h3>
                            <div class="form-group">
                                <label for="date">Date:</label>
                                <input type="date" id="date" required>
                            </div>

                            <div class="form-group">
                                <label for="bikeBrand">Bicycle Brand/Model:</label>
                                <input type="text" id="bikeBrand" placeholder="e.g., Trek, Specialized, Giant" required>
                            </div>

                            <div class="form-group">
                                <label for="bikeColor">Color:</label>
                                <input type="text" id="bikeColor" required>
                            </div>

                            <div class="form-group">
                                <label>Bicycle Type:</label>
                                <div class="radio-group">
                                    <input type="radio" id="mountain" name="bikeType" value="mountain">
                                    <label for="mountain">Mountain Bike</label>

                                    <input type="radio" id="road" name="bikeType" value="road">
                                    <label for="road">Road Bike</label>

                                    <input type="radio" id="electric" name="bikeType" value="electric">
                                    <label for="electric">Electric Bike</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="additionalSpecs">Additional Specifications:</label>
                                <textarea id="additionalSpecs" rows="4"
                                    placeholder="Add any additional specifications, components, or notes..."></textarea>
                            </div>
                        </div>

                        <button type="submit">Register Customer & Bicycle</button>
                    </form>
                </div>

                <!-- Existing Customer Search -->
                <div id="existingCustomerSection" class="customer-form-section" style="display: none;">
                    <h2>Search Existing Customer</h2>
                    <button onclick="backToCustomerSelection()" class="back-btn">‚Üê Back to Selection</button>

                    <div class="form-group">
                        <label for="existingCustomerSearch">Search Customer:</label>
                        <input type="text" id="existingCustomerSearch"
                            placeholder="Enter customer name or phone number..." onkeyup="searchExistingCustomers()">
                    </div>

                    <div id="existingCustomerResults" class="customer-results">
                        <!-- Search results will appear here -->
                    </div>
                </div>

                <!-- Selected Customer Bicycle Form -->
                <div id="selectedCustomerSection" class="customer-form-section" style="display: none;">
                    <div id="selectedCustomerInfo" class="selected-customer-info">
                        <!-- Selected customer info will appear here -->
                    </div>

                    <button onclick="backToExistingCustomerSearch()" class="back-btn">‚Üê Back to Search</button>

                    <form id="existingCustomerBicycleForm">
                        <div class="bicycle-info-section">
                            <h3>Add New Bicycle</h3>
                            <div class="form-group">
                                <label for="existingDate">Date:</label>
                                <input type="date" id="existingDate" required>
                            </div>

                            <div class="form-group">
                                <label for="existingBikeBrand">Bicycle Brand/Model:</label>
                                <input type="text" id="existingBikeBrand" placeholder="e.g., Trek, Specialized, Giant"
                                    required>
                            </div>

                            <div class="form-group">
                                <label for="existingBikeColor">Color:</label>
                                <input type="text" id="existingBikeColor" required>
                            </div>

                            <div class="form-group">
                                <label>Bicycle Type:</label>
                                <div class="radio-group">
                                    <input type="radio" id="existingMountain" name="existingBikeType" value="mountain">
                                    <label for="existingMountain">Mountain Bike</label>

                                    <input type="radio" id="existingRoad" name="existingBikeType" value="road">
                                    <label for="existingRoad">Road Bike</label>

                                    <input type="radio" id="existingElectric" name="existingBikeType" value="electric">
                                    <label for="existingElectric">Electric Bike</label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="existingAdditionalSpecs">Additional Specifications:</label>
                                <textarea id="existingAdditionalSpecs" rows="4"
                                    placeholder="Add any additional specifications, components, or notes..."></textarea>
                            </div>
                        </div>

                        <button type="submit">Add Bicycle to Customer</button>
                    </form>
                </div>
            </div>

            <!-- Stage 2: Job Offers -->
            <div id="jobs" class="tab-content">
                <h2>JOB OFFERS & REPAIRS</h2>
                <div id="jobsContent">
                    <div class="empty-state" id="emptyJobsState">
                        <div class="empty-icon">EMPTY</div>
                        <h3>No Bicycles Registered Yet</h3>
                        <p>Register a bicycle first to create job offers and repair estimates.</p>
                        <button onclick="showTab('register')" class="empty-action-btn">Register First Bicycle</button>
                    </div>
                    <div id="bicycleList"></div>
                </div>
            </div>

            <!-- History -->
            <div id="history" class="tab-content">
                <h2>Workshop History</h2>
                <div id="historyContent"></div>
            </div>

            <!-- Database Management -->
            <div id="database" class="tab-content">
                <h2>Database Management</h2>

                <!-- Data Storage Information -->
                <div class="storage-info">
                    <h3>DATA STORAGE LOCATION</h3>
                    <div class="storage-details">
                        <div class="storage-item">
                            <span class="storage-icon">üî•</span>
                            <div class="storage-text">
                                <strong>Firebase Cloud Database</strong>
                                <p>Data is securely stored in Google Firebase Firestore</p>
                            </div>
                        </div>
                        <div class="storage-item">
                            <span class="storage-icon">‚òÅÔ∏è</span>
                            <div class="storage-text">
                                <strong>Cloud Synchronized</strong>
                                <p>Access your data from any device, anywhere</p>
                            </div>
                        </div>
                        <div class="storage-item">
                            <span class="storage-icon">üîí</span>
                            <div class="storage-text">
                                <strong>Secure & Backed Up</strong>
                                <p>Enterprise-grade security with automatic backups</p>
                            </div>
                        </div>
                        <div class="storage-item">
                            <span class="storage-icon">üìä</span>
                            <div class="storage-text">
                                <strong>4 Data Categories</strong>
                                <p>Customers, Bicycles, Job Offers, Repair History</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Firebase Migration Section -->
                <div class="migration-section" id="migrationSection" style="display: none;">
                    <h3>üîÑ MIGRATE FROM LOCAL STORAGE</h3>
                    <div class="migration-info">
                        <p>We detected data in your browser's local storage. Would you like to migrate it to Firebase?
                        </p>
                        <div class="migration-actions">
                            <button onclick="startMigration()" class="migrate-btn">
                                üöÄ MIGRATE TO FIREBASE
                            </button>
                            <button onclick="downloadLocalBackup()" class="backup-btn">
                                üíæ BACKUP LOCAL DATA
                            </button>
                        </div>
                        <div id="migrationStatus" class="migration-status"></div>
                    </div>
                </div>

                <div class="database-section">
                    <h3>Customer Database</h3>
                    <div id="customerStats" class="stats-grid">
                        <!-- Will be populated by JavaScript -->
                    </div>

                    <h3>Database Actions</h3>
                    <div class="database-actions">
                        <button onclick="exportData()" class="export-btn">
                            EXPORT ALL CSV FILES
                        </button>

                        <div class="import-section">
                            <input type="file" id="importFile" accept=".json" onchange="importData(event)"
                                style="display: none;">
                            <button onclick="document.getElementById('importFile').click()" class="import-btn">
                                IMPORT JSON BACKUP
                            </button>
                        </div>

                        <button onclick="clearDatabase()" class="clear-btn">
                            CLEAR ALL DATA
                        </button>
                    </div>

                    <h3>Individual CSV Exports</h3>
                    <div class="database-actions">
                        <button onclick="exportCustomersCSV()" class="export-btn">
                            CUSTOMERS CSV
                        </button>

                        <button onclick="exportBicyclesCSV()" class="export-btn">
                            BICYCLES CSV
                        </button>

                        <button onclick="exportJobOffersCSV()" class="export-btn">
                            JOB OFFERS CSV
                        </button>

                        <button onclick="exportRepairHistoryCSV()" class="export-btn">
                            REPAIR HISTORY CSV
                        </button>
                    </div>

                    <h3>Customer Search</h3>
                    <div class="search-section">
                        <input type="text" id="customerSearch" placeholder="Search customers by name or phone..."
                            onkeyup="searchCustomers()">
                        <div id="searchResults"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Make Firebase available globally
        window.Firebase = { initializeApp, getFirestore, getAuth };
    </script>

    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="firebase-database.js"></script>
    <script type="module" src="firebase-migration.js"></script>
    <script src="script.js"></script>
    <script src="data-export.js"></script>
    <script src="local-database.js"></script>

    <!-- Firebase Integration Script -->
    <script type="module">
        import FirebaseMigration from './firebase-migration.js';

        // Make Firebase functions available globally
        window.firebaseMigration = new FirebaseMigration();

        // Check for local data and show migration section
        document.addEventListener('DOMContentLoaded', function () {
            checkForLocalData();
            showFirebaseStatus();
        });

        // Check if local data exists
        function checkForLocalData() {
            if (window.firebaseMigration.hasLocalData()) {
                document.getElementById('migrationSection').style.display = 'block';
            }
        }

        // Show Firebase connection status
        function showFirebaseStatus() {
            // This will be implemented based on your Firebase config
            console.log('Firebase integration ready');
        }

        // Global migration functions
        window.startMigration = async function () {
            const statusDiv = document.getElementById('migrationStatus');
            statusDiv.innerHTML = '<div class="firebase-loading">Migrating data to Firebase...</div>';
            statusDiv.className = 'migration-status loading';

            try {
                const result = await window.firebaseMigration.performFullMigration();

                if (result.success) {
                    statusDiv.innerHTML = `
                        <div>
                            <strong>‚úÖ Migration Successful!</strong><br>
                            ${result.migratedData ?
                            `Migrated: ${result.migratedData.customers} customers, ${result.migratedData.bicycles} bicycles, ${result.migratedData.jobOffers} job offers, ${result.migratedData.repairHistory} repair records`
                            : result.message}
                        </div>
                    `;
                    statusDiv.className = 'migration-status success';

                    // Hide migration section after successful migration
                    setTimeout(() => {
                        document.getElementById('migrationSection').style.display = 'none';
                    }, 5000);
                } else {
                    statusDiv.innerHTML = `<strong>‚ùå Migration Failed:</strong><br>${result.message}`;
                    statusDiv.className = 'migration-status error';
                }
            } catch (error) {
                statusDiv.innerHTML = `<strong>‚ùå Migration Error:</strong><br>${error.message}`;
                statusDiv.className = 'migration-status error';
            }
        };

        window.downloadLocalBackup = function () {
            try {
                window.firebaseMigration.backupLocalData();
                showNotification('Local data backup downloaded successfully!', 'success');
            } catch (error) {
                showNotification('Failed to create backup: ' + error.message, 'error');
            }
        };
    </script>
</body>

</html>